<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta content='IE=edge;chrome=1' http-equiv='X-UA-Compatible'>
    <meta content='width=device-width, initial-scale=1, user-scalable=yes' name='viewport'>
    <meta content='#9CE8AC' name='theme-color'>
    <title>
      PE-Notes  - Testing high concurrency http server
    </title>
    <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="/feed.xml" />
    <link href="/stylesheets/application-24cc418f.css" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/mobile-b135630e.css" rel="stylesheet" type="text/css" media="only screen and (max-device-width : 640px), screen and (max-width : 640px)" />
  </head>
  <body>
    <header>
      <div class='inner'><a href='/'><h2>Pavel's Notes</h2>
        <br>
        <h4>About programming in Ruby, Javascript, D</h4></a></div>
    </header>
    <div class='page-wrapper'>
      <div id='main' role='main'>
        <article class='blog-post'>
          <h2 class='title'>
            Testing high concurrency http server
            <br>
            <span class='date'>Apr 17, 2015</span>
          </h2>
          <p>I was making some research for one of upcoming project at my job. I needed to test http server if it can handle 500-1500 concurrent requests.</p>
          
          <p>It&#39;s was more hard to make right testing rather then right server. Web server don&#39;t have any record in error log and could process requests that I sent with curl while load test is running.</p>
          
          <h3>Setup</h3>
          
          <p>First I setup Nginx with <a href="http://wiki.nginx.org/HttpEchoModule">HttpEchoModule</a>, I used <a href="http://openresty.org/">openresty</a> to easily configure and compile with extra modules.</p>
          
          <p>Next I create config to wait 3 seconds and response with some text.</p>
          
          <p>I choose nginx as example to compare with real application.</p>
          <pre class="highlight nginx"><code><span class="k">location</span> <span class="n">/</span> <span class="p">{</span>&#x000A;    <span class="kn">add_header</span> <span class="s">Content-Disposition</span> <span class="s">"inline"</span><span class="p">;</span>&#x000A;    <span class="kn">add_header</span> <span class="s">Content-Type</span> <span class="s">"text/plain"</span><span class="p">;</span>&#x000A;&#x000A;    <span class="kn">echo_sleep</span> <span class="mi">3</span><span class="p">;</span>&#x000A;    <span class="kn">echo</span> <span class="s">"response</span> <span class="s">text"</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;</code></pre>
          
          <h3>Testing</h3>
          
          <p>Then I start to test how many requests it can process at same time:</p>
          <pre class="highlight shell"><code>ab -n 100 -c 100 http://127.0.0.1:7080/&#x000A;<span class="c"># =&gt; ok</span>&#x000A;ab -n 200 -c 200 http://127.0.0.1:7080/&#x000A;<span class="c"># =&gt; ok</span>&#x000A;ab -n 500 -c 500 http://127.0.0.1:7080/&#x000A;<span class="c"># =&gt; socket: Too many open files (24)</span>&#x000A;</code></pre>
          
          <p>Probably we hit system limitation on max open files per process.</p>
          
          <p></p>
          
          <p>After hours I fine this manual most useful</p>
          
          <p><a href="http://b.oldhu.com/2012/07/19/increase-tcp-max-connections-on-mac-os-x/">http:&#47;&#47;b.oldhu.com&#47;2012&#47;07&#47;19&#47;increase-tcp-max-connections-on-mac-os-x&#47;</a></p>
          
          <p>I also increase <code>worker_processes</code> and <code>worker_connections</code>in nginx:</p>
          <pre class="highlight nginx"><code><span class="k">worker_processes</span>  <span class="mi">2</span><span class="p">;</span>&#x000A;<span class="k">events</span> <span class="p">{</span>&#x000A;  <span class="kn">worker_connections</span>  <span class="mi">4096</span><span class="p">;</span>&#x000A;<span class="p">}</span>&#x000A;<span class="k">worker_rlimit_nofile</span>    <span class="mi">8000</span><span class="p">;</span>&#x000A;</code></pre>
          
          <p>After increase limitations try again </p>
          <pre class="highlight shell"><code>ab -n 700 -c 700 http://127.0.0.1:7080/&#x000A;<span class="c"># =&gt; ok</span>&#x000A;ab -n 900 -c 900 http://127.0.0.1:7080/&#x000A;<span class="c"># =&gt; sometimes ok</span>&#x000A;<span class="c"># =&gt; sometimes "apr_socket_recv: Connection reset by peer (54)"</span>&#x000A;</code></pre>
          
          <p>Keep increasing:</p>
          <pre class="highlight shell"><code>ab -n 1100 -c 1100 http://127.0.0.1:7080/&#x000A;<span class="c"># =&gt; ok or apr_socket_recv error</span>&#x000A;ab -n 3000 -c 3000 http://127.0.0.1:7080/&#x000A;<span class="c"># =&gt; ok or apr_socket_recv error</span>&#x000A;ab -n 9000 -c 1000 http://127.0.0.1:7080/&#x000A;<span class="c"># =&gt; apr_socket_recv: Connection reset by peer (54)</span>&#x000A;<span class="c"># =&gt; Total of 455 requests completed</span>&#x000A;&#x000A;</code></pre>
          
          <p>So I could make 3000 parallel requests and get a response in 3.183 sec. But sometimes it fails with error in <code>ab</code> tool. And it can&#39;t process when reqs &gt; conns. I wasn&#39;t happy with it, so I try:</p>
          
          <ul>
          <li><strong>wrk</strong> - it didn&#39;t work before, but after I reboot it seems to work ok</li>
          <li><strong>httperf</strong> - I could not manage to send as many request as I want</li>
          <li><strong>siege</strong> - was better but still could not make many requests</li>
          </ul>
          
          <p>What make me happy is a utility called <a href="https://github.com/rakyll/boom"><strong>boom</strong></a></p>
          
          <p>Written in GO and source on github:</p>
          
          <p><a href="https://github.com/rakyll/boom">https:&#47;&#47;github.com&#47;rakyll&#47;boom</a></p>
          
          <p>There is no binary for mac, so need to compile:</p>
          <pre class="highlight shell"><code>brew install go&#x000A;<span class="nb">export </span><span class="nv">GOPATH</span><span class="o">=</span>~/go&#x000A;go get github.com/rakyll/boom&#x000A;</code></pre>
          
          <p>Using boom:</p>
          <pre class="highlight plaintext"><code>~/go/bin/boom -n 8000 -c 1500 -disable-keepalive http://127.0.0.1:7080&#x000A;</code></pre>
          
          <p>It has:</p>
          
          <ul>
          <li>nice progress bar</li>
          <li>can handle many requests (eg 30k reqs with 1500 conns) </li>
          <li>can handle as much concurrency as I need</li>
          <li>keep going on error</li>
          <li>has nice diagram</li>
          </ul>
          
          <p>Progress bar:</p>
          <pre class="highlight plaintext"><code>~/go/bin/boom -n 9000 -c 1500 -disable-keepalive http://127.0.0.1:7080&#x000A;4500 / 9000 Boooooooooooooooooooooom                                 ! 50.00 % 9s&#x000A;</code></pre>
          
          <p>Output looks like this:</p>
          <pre class="highlight plaintext"><code>% ~/go/bin/boom -n 9000 -c 1500 -disable-keepalive http://127.0.0.1:7080&#x000A;9000 / 9000 Booooooooooooooooooooooooooooooooooooooooooooooooooooooooo! 100.00 % &#x000A;&#x000A;Summary:&#x000A;  Total:    18.6023 secs.&#x000A;  Slowest:  3.2399 secs.&#x000A;  Fastest:  2.9995 secs.&#x000A;  Average:  3.0652 secs.&#x000A;  Requests/sec: 483.8105&#x000A;&#x000A;Status code distribution:&#x000A;  [200] 9000 responses&#x000A;&#x000A;Response time histogram:&#x000A;  2.999 [1] |&#x000A;  3.024 [2383]  |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎&#x000A;  3.048 [1883]  |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎&#x000A;  3.072 [2011]  |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎&#x000A;  3.096 [1219]  |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎&#x000A;  3.120 [7] |&#x000A;  3.144 [188]   |∎∎∎&#x000A;  3.168 [147]   |∎∎&#x000A;  3.192 [361]   |∎∎∎∎∎∎&#x000A;  3.216 [656]   |∎∎∎∎∎∎∎∎∎∎∎&#x000A;  3.240 [144]   |∎∎&#x000A;&#x000A;Latency distribution:&#x000A;  10% in 3.0045 secs.&#x000A;  25% in 3.0219 secs.&#x000A;  50% in 3.0493 secs.&#x000A;  75% in 3.0832 secs.&#x000A;  90% in 3.1882 secs.&#x000A;  95% in 3.2031 secs.&#x000A;  99% in 3.2162 secs.&#x000A;</code></pre>
          
          <h3>Node.js app:</h3>
          
          <p>Next I write same functionality in Node.js:</p>
          <pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">PORT</span> <span class="o">=</span> <span class="mi">7090</span><span class="p">;</span>&#x000A;<span class="kd">var</span> <span class="nx">reqN</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>&#x000A;&#x000A;<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>&#x000A;  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Req"</span><span class="p">,</span> <span class="nx">reqN</span><span class="o">++</span><span class="p">);</span>&#x000A;  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>&#x000A;    <span class="nx">response</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s1">'content-type'</span><span class="p">,</span> <span class="s1">'text/plain'</span><span class="p">);</span>&#x000A;    <span class="nx">response</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s2">"response"</span><span class="p">);</span>&#x000A;  <span class="p">},</span> <span class="mi">3000</span><span class="p">);</span>&#x000A;<span class="p">});</span>&#x000A;&#x000A;<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">7090</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>&#x000A;    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Server listening on: http://localhost:%s"</span><span class="p">,</span> <span class="nx">PORT</span><span class="p">);</span>&#x000A;<span class="p">});</span>&#x000A;</code></pre>
          
          <p>It does same: wait 3 seconds and response with <code>&quot;response&quot;</code> body.</p>
          
          <p>I run it with latest iojs (1.7.1). Benchmark result is almost same:</p>
          <pre class="highlight plaintext"><code>~/go/bin/boom -n 15000 -c 1500 -disable-keepalive http://127.0.0.1:7090&#x000A;# ...&#x000A;Response time histogram:&#x000A;  3.000 [1] |&#x000A;  3.039 [6930]  |∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎∎&#x000A;  3.078 [1682]  |∎∎∎∎∎∎∎∎∎&#x000A;  3.118 [1204]  |∎∎∎∎∎∎&#x000A;  3.157 [644]   |∎∎∎&#x000A;  3.196 [1016]  |∎∎∎∎∎&#x000A;  3.235 [875]   |∎∎∎∎∎&#x000A;  3.275 [1291]  |∎∎∎∎∎∎∎&#x000A;  3.314 [890]   |∎∎∎∎∎&#x000A;  3.353 [262]   |∎&#x000A;  3.393 [205]   |∎&#x000A;</code></pre>
          
          <h3>Bottom line:</h3>
          
          <p>For future research and development I prefer to use  <em>boom</em>, it&#39;s hassle-free, can handle really high number of parallel requests, have nice output.</p>
          
          <p>In this review I skip tool called jMetter, because it have GUI and looks ugly on mac, also because written in Java</p>
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          //<![CDATA[
                            var disqus_shortname = 'pe-notes';
                    
              (function() {
                  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
          //]]>
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          
        </article>
      </div>
      <aside>
        <h2>Recent Articles</h2>
        <ol>
          <li>
            <a href="/2015/04/17/testing-high-concurrency-http-server.html">Testing high concurrency http server</a>
            <br>
            <span class='date'>Apr 17, 2015</span>
          </li>
          <li>
            <a href="/2015/03/02/synchronous-javascript-with-fibers.html">Synchronous Javascript with fibers</a>
            <br>
            <span class='date'>Mar  2, 2015</span>
          </li>
          <li>
            <a href="/2015/01/29/convert-mysql-database-to-postgresql.html">Convert mysql database to postgresql</a>
            <br>
            <span class='date'>Jan 29, 2015</span>
          </li>
          <li>
            <a href="/2015/01/27/validating-hash-params-in-ruby.html">Validating hash params in ruby</a>
            <br>
            <span class='date'>Jan 27, 2015</span>
          </li>
          <li>
            <a href="/2015/01/14/handle-exceptions-in-d.html">Handle exceptions in D</a>
            <br>
            <span class='date'>Jan 14, 2015</span>
          </li>
          <li>
            <a href="/2015/01/13/anonymous-functions-in-d.html">Anonymous functions in D</a>
            <br>
            <span class='date'>Jan 13, 2015</span>
          </li>
          <li>
            <a href="/2014/10/28/itunes-12-blue-icon.html">iTunes 12 blue icon</a>
            <br>
            <span class='date'>Oct 28, 2014</span>
          </li>
          <li>
            <a href="/2014/09/29/convert-ruby-time-to-server-timezone.html">Convert ruby time to server timezone</a>
            <br>
            <span class='date'>Sep 29, 2014</span>
          </li>
          <li>
            <a href="/2014/08/26/node-js-standart-libs-auto-require.html">Node.js standart libs auto-require</a>
            <br>
            <span class='date'>Aug 26, 2014</span>
          </li>
          <li>
            <a href="/2014/07/16/continuous-testing-for-d.html">Continuous testing for D</a>
            <br>
            <span class='date'>Jul 16, 2014</span>
          </li>
        </ol>
      </aside>
    </div>
  </body>
</html>
